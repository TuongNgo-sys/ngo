import streamlit as st
import requests
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta

# ===============================
# HÃ m láº¥y dá»¯ liá»‡u thá»i tiáº¿t thá»±c táº¿ tá»« Open-Meteo
# ===============================
def get_weather():
    try:
        url = "https://api.open-meteo.com/v1/forecast"
        params = {
            "latitude": 10.8486,
            "longitude": 106.7903,
            "hourly": "temperature_2m,relative_humidity_2m,precipitation_probability,cloudcover",
            "current": "temperature_2m,relative_humidity_2m,precipitation,cloudcover",
            "daily": "rain_sum,precipitation_probability_max",
            "timezone": "Asia/Bangkok"
        }
        res = requests.get(url, params=params)
        res.raise_for_status()
        data = res.json()

        current = data.get("current", {})
        daily = data.get("daily", {})

        return {
            "temperature": current.get("temperature_2m"),
            "humidity": current.get("relative_humidity_2m"),
            "cloud": current.get("cloudcover"),
            "rain_chance": daily.get("precipitation_probability_max", [0])[0],
            "rain_amount": daily.get("rain_sum", [0])[0],
        }
    except:
        return None

# ===============================
# HÃ m so sÃ¡nh dá»¯ liá»‡u cáº£m biáº¿n vá»›i thá»i tiáº¿t
# ===============================
def compare_data(sensor, weather):
    if not weather:
        return {"Lá»—i": "KhÃ´ng cÃ³ dá»¯ liá»‡u thá»i tiáº¿t Ä‘á»ƒ so sÃ¡nh."}
    diff_temp = sensor['temp'] - weather['temperature']
    diff_humidity = sensor['humidity'] - weather['humidity']
    diff_light = sensor['light'] - (100 - weather['cloud'])

    return {
        "ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™ chÃªnh lá»‡ch (Â°C)": round(diff_temp, 1),
        "ğŸ’§ Äá»™ áº©m chÃªnh lá»‡ch (%)": round(diff_humidity, 1),
        "ğŸ”† Ãnh sÃ¡ng chÃªnh lá»‡ch (%)": round(diff_light, 1),
    }

# ===============================
# HÃ m Æ°á»›c lÆ°á»£ng ngÃ y thu hoáº¡ch
# ===============================
def estimate_harvest(crop, plant_date):
    if not crop or not plant_date:
        return ""
    crop = crop.lower()
    if "lÃºa" in crop:
        days = 100
    elif "rau" in crop:
        days = 30
    elif "báº¯p" in crop or "ngÃ´" in crop:
        days = 90
    elif "chuá»‘i" in crop:
        days = 300
    else:
        days = 60  # máº·c Ä‘á»‹nh
    harvest_date = plant_date + timedelta(days=days)
    return harvest_date.strftime("%d/%m/%Y")

# ===============================
# Giao diá»‡n chÃ­nh Streamlit
# ===============================
st.set_page_config(page_title="Há»‡ thá»‘ng tÆ°á»›i tiÃªu thÃ´ng minh", layout="centered")

st.title("ğŸŒ± Há»† THá»NG TÆ¯á»šI TIÃŠU THÃ”NG MINH")
st.caption(f"â° Thá»i gian hiá»‡n táº¡i: {datetime.now().strftime('%H:%M:%S %d/%m/%Y')}")

# Pháº§n 1: Dá»¯ liá»‡u thá»i tiáº¿t
st.header("1ï¸âƒ£ Dá»¯ liá»‡u thá»i tiáº¿t thá»±c táº¿ (API Open-Meteo)")
weather = get_weather()

if weather:
    st.success("âœ… Dá»¯ liá»‡u thá»i tiáº¿t cáº­p nháº­t thÃ nh cÃ´ng")
    col1, col2 = st.columns(2)
    with col1:
        st.metric("ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™", f"{weather['temperature']} Â°C")
        st.metric("â˜ï¸ MÃ¢y che", f"{weather['cloud']} %")
        st.metric("ğŸ’§ Äá»™ áº©m", f"{weather['humidity']} %")
    with col2:
        st.metric("ğŸŒ§ï¸ XÃ¡c suáº¥t mÆ°a", f"{weather['rain_chance']} %")
        st.metric("ğŸ“ LÆ°á»£ng mÆ°a dá»± bÃ¡o", f"{weather['rain_amount']} mm")
else:
    st.error("âš ï¸ KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u thá»i tiáº¿t. Vui lÃ²ng kiá»ƒm tra káº¿t ná»‘i máº¡ng hoáº·c API.")

# Pháº§n 2: Nháº­p dá»¯ liá»‡u cáº£m biáº¿n
st.header("2ï¸âƒ£ Dá»¯ liá»‡u cáº£m biáº¿n táº¡i vÆ°á»n")
sensor = {
    'temp': st.number_input("ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™ Ä‘o Ä‘Æ°á»£c (Â°C)", value=0.0),
    'humidity': st.number_input("ğŸ’§ Äá»™ áº©m Ä‘o Ä‘Æ°á»£c (%)", value=0.0),
    'light': st.number_input("ğŸ”† Ãnh sÃ¡ng Ä‘o Ä‘Æ°á»£c (%)", value=0.0),
}

# Pháº§n 3: So sÃ¡nh dá»¯ liá»‡u
st.header("3ï¸âƒ£ So sÃ¡nh dá»¯ liá»‡u thá»±c táº¿ vÃ  cáº£m biáº¿n")
if st.button("ğŸ“Š Thá»±c hiá»‡n so sÃ¡nh"):
    result = compare_data(sensor, weather)
    st.subheader("ğŸ“ˆ Káº¿t quáº£ chÃªnh lá»‡ch:")
    for key, value in result.items():
        st.write(f"- {key}: **{value}**")

# Pháº§n 4: Æ¯á»›c lÆ°á»£ng ngÃ y thu hoáº¡ch
st.header("4ï¸âƒ£ Æ¯á»›c lÆ°á»£ng ngÃ y thu hoáº¡ch")
crop = st.text_input("ğŸŒ¾ Nháº­p loáº¡i cÃ¢y trá»“ng (VD: lÃºa, rau, báº¯p,...)")
plant_date = st.date_input("ğŸ“… NgÃ y gieo trá»“ng")

if st.button("ğŸ“… TÃ­nh ngÃ y thu hoáº¡ch"):
    result = estimate_harvest(crop, plant_date)
    if result:
        st.success(f"ğŸŒŸ Dá»± kiáº¿n thu hoáº¡ch vÃ o ngÃ y: **{result}**")
    else:
        st.warning("âš ï¸ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin.")
